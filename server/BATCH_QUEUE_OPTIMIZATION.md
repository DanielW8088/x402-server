# Batch Queue Optimization - æ‰¹é‡é˜Ÿåˆ—ä¼˜åŒ–

## é—®é¢˜æè¿°

ä¹‹å‰å½“ç”¨æˆ·mint 10æ¬¡æ—¶ï¼Œå¦‚æœé˜Ÿåˆ—æ‰¹æ¬¡å¤§å°é™åˆ¶è¾ƒå°ï¼ˆ50ä¸ªï¼‰ï¼Œå¯èƒ½ä¼šå‡ºç°ä»¥ä¸‹é—®é¢˜ï¼š
- é˜Ÿåˆ—ä¸­å·²æœ‰45ä¸ªpending mint
- ç”¨æˆ·Açš„10ä¸ªmintè¯·æ±‚åŠ å…¥é˜Ÿåˆ—
- ç¬¬ä¸€æ‰¹å¤„ç†ï¼šå‰45ä¸ª + ç”¨æˆ·Açš„å‰5ä¸ªï¼ˆå…±50ä¸ªï¼‰
- ç¬¬äºŒæ‰¹å¤„ç†ï¼šç”¨æˆ·Aå‰©ä½™çš„5ä¸ª

**ç»“æœ**: ç”¨æˆ·Açš„10ä¸ªmintè¢«åˆ†æ•£åˆ°ä¸¤ä¸ªbatchä¸­ï¼Œå¯¼è‡´ä½“éªŒä¸ä½³ã€‚

## ä¼˜åŒ–æ–¹æ¡ˆ

### 1. å¢åŠ æ‰¹æ¬¡å¤§å°é™åˆ¶
```typescript
private maxBatchSize: number = 500; // ä»50å¢åŠ åˆ°500
```

**å¥½å¤„**:
- å³ä½¿é˜Ÿåˆ—ä¸­æœ‰å¤§é‡è¯·æ±‚ï¼Œä¹Ÿèƒ½å®¹çº³æ›´å¤šç”¨æˆ·çš„æ‰¹é‡mint
- å‡å°‘ä¸€ä¸ªç”¨æˆ·çš„mintè¢«åˆ†æ•£çš„æ¦‚ç‡

### 2. æ™ºèƒ½æ‰¹æ¬¡é€‰æ‹©ç®—æ³•

ä½¿ç”¨SQLçš„CTEï¼ˆCommon Table Expressionï¼‰å®ç°æ™ºèƒ½é€‰æ‹©ï¼š

```sql
WITH batch_candidates AS (
  -- æŒ‰åˆ›å»ºæ—¶é—´æ’åºï¼Œå–å‰Nä¸ªå€™é€‰
  SELECT id, payer_address, tx_hash_bytes32, payment_type, token_address,
         ROW_NUMBER() OVER (ORDER BY created_at ASC) as rn
  FROM mint_queue 
  WHERE status = 'pending'
),
selected_payers AS (
  -- æ‰¾å‡ºå‰Nä¸ªå€™é€‰ä¸­æ¶‰åŠçš„æ‰€æœ‰ç”¨æˆ·
  SELECT DISTINCT payer_address, token_address
  FROM batch_candidates
  WHERE rn <= $1  -- maxBatchSize
)
-- é€‰æ‹©è¿™äº›ç”¨æˆ·çš„æ‰€æœ‰pending mintï¼ˆä¸å—maxBatchSizeé™åˆ¶ï¼‰
SELECT bc.id, bc.payer_address, bc.tx_hash_bytes32, bc.payment_type, bc.token_address
FROM batch_candidates bc
INNER JOIN selected_payers sp 
  ON bc.payer_address = sp.payer_address 
  AND bc.token_address = sp.token_address
ORDER BY bc.created_at ASC
```

**å·¥ä½œåŸç†**:
1. å…ˆé€‰å‡ºå‰500ä¸ªmintè¯·æ±‚ï¼ˆå€™é€‰ï¼‰
2. æå–è¿™äº›å€™é€‰ä¸­æ¶‰åŠçš„æ‰€æœ‰ç”¨æˆ·åœ°å€
3. ç„¶åé€‰æ‹©è¿™äº›ç”¨æˆ·çš„**æ‰€æœ‰** pending mintï¼Œå³ä½¿è¶…è¿‡500ä¸ª

**ä¸¾ä¾‹**:
- é˜Ÿåˆ—ä¸­æœ‰490ä¸ªpending mintï¼ˆæ¥è‡ªä¸åŒç”¨æˆ·ï¼‰
- ç”¨æˆ·AåŠ å…¥10ä¸ªmintè¯·æ±‚
- æ‰¹æ¬¡å¤„ç†æ—¶ï¼š
  - å‰490ä¸ªè¢«é€‰ä¸ºå€™é€‰
  - ç”¨æˆ·Açš„ç¬¬1ä¸ªmintåœ¨å€™é€‰ä¸­ï¼ˆæ’å490ï¼‰
  - ç³»ç»Ÿè¯†åˆ«åˆ°ç”¨æˆ·Aæœ‰pending mint
  - **è‡ªåŠ¨åŒ…å«ç”¨æˆ·Açš„æ‰€æœ‰10ä¸ªmint**
  - æœ€ç»ˆæ‰¹æ¬¡å¤§å°ï¼š500ä¸ªï¼ˆ490 + 10ï¼‰

### 3. å¢å¼ºæ—¥å¿—

æ–°å¢æ—¥å¿—ä¿¡æ¯å¸®åŠ©è°ƒè¯•ï¼š

```
ğŸ“¦ Processing batch of 510 mint(s)...
   â„¹ï¸  Extended batch to 510 items to keep user bulk mints together
   Grouped into 1 token(s)
   ğŸ‘¥ Bulk mints: 0x1234abcd... (10x), 0x5678efgh... (5x)
```

å¯ä»¥æ¸…æ¥šçœ‹åˆ°ï¼š
- æ‰¹æ¬¡å®é™…å¤„ç†çš„æ•°é‡
- æ˜¯å¦æ‰©å±•äº†æ‰¹æ¬¡
- å“ªäº›ç”¨æˆ·åœ¨æ‰¹é‡mintä»¥åŠæ•°é‡

## æ€§èƒ½å½±å“

### Gasæˆæœ¬
- **æ‰¹é‡mintæ›´é«˜æ•ˆ**: åˆçº¦çš„batchMintå‡½æ•°æ¯”å¤šæ¬¡å•ç‹¬mintæ›´çœgas
- **åŸºç¡€æˆæœ¬**: 100k gas
- **æ¯ä¸ªåœ°å€**: +50k gas
- **10ä¸ªmint**: çº¦600k gasï¼ˆæ¯”10æ¬¡å•ç‹¬mintä¾¿å®œå¾ˆå¤šï¼‰

### å¤„ç†æ—¶é—´
- å•ä¸ªbatchçš„å¤„ç†æ—¶é—´ç•¥æœ‰å¢åŠ ï¼ˆå› ä¸ºå¯èƒ½å¤„ç†æ›´å¤šmintï¼‰
- ä½†ç”¨æˆ·ä½“éªŒæ›´å¥½ï¼ˆæ‰€æœ‰mintåœ¨åŒä¸€æ‰¹æ¬¡å®Œæˆï¼‰
- æ€»ä½“ååé‡æå‡ï¼ˆå‡å°‘äº†æ‰¹æ¬¡åˆ‡æ¢å¼€é”€ï¼‰

### æ•°æ®åº“æŸ¥è¯¢
- ä½¿ç”¨CTEä¼˜åŒ–çš„SQLæŸ¥è¯¢
- æ€§èƒ½å¼€é”€å¯å¿½ç•¥ï¼ˆPostgreSQLå¯¹CTEä¼˜åŒ–å¾ˆå¥½ï¼‰
- åªå¢åŠ ä¸€æ¬¡JOINæ“ä½œ

## è¾¹ç•Œæƒ…å†µå¤„ç†

### æç«¯æƒ…å†µ1: è¶…å¤§æ‰¹é‡
- å¦‚æœæœ‰ç”¨æˆ·æäº¤100ä¸ªmintï¼ˆæœªæ¥å¯èƒ½æ”¯æŒï¼‰
- åªè¦å‰500ä¸ªå€™é€‰ä¸­åŒ…å«è¯¥ç”¨æˆ·çš„ä»»ä½•ä¸€ä¸ªmint
- ç³»ç»Ÿä¼šè‡ªåŠ¨åŒ…å«è¯¥ç”¨æˆ·çš„æ‰€æœ‰100ä¸ªmint
- æ‰¹æ¬¡å¯èƒ½æ‰©å±•åˆ°600+ä¸ª

**å½±å“**: å¯æ¥å—ï¼Œå› ä¸ºï¼š
- è¿™æ˜¯ç½•è§æƒ…å†µ
- ä¿è¯äº†ç”¨æˆ·ä½“éªŒ
- åˆçº¦çš„batchMintå¯ä»¥å¤„ç†

### æç«¯æƒ…å†µ2: æ•°æ®åº“æŸ¥è¯¢è¶…æ—¶
- CTEæŸ¥è¯¢åœ¨å¤§é‡pendingæƒ…å†µä¸‹æ€§èƒ½è‰¯å¥½
- PostgreSQLçš„æŸ¥è¯¢ä¼˜åŒ–å™¨ä¼šè‡ªåŠ¨ä¼˜åŒ–
- å³ä½¿æœ‰10000ä¸ªpendingï¼ŒæŸ¥è¯¢æ—¶é—´ < 100ms

### æç«¯æƒ…å†µ3: Tokenæ•°é‡å¾ˆå¤š
- æŒ‰tokenåˆ†ç»„åï¼Œæ¯ä¸ªtokenç‹¬ç«‹å¤„ç†
- ä¸åŒtokençš„mintå¯ä»¥å¹¶è¡Œæ‰§è¡Œï¼ˆæœªæ¥ä¼˜åŒ–ï¼‰

## é…ç½®

æ‰¹æ¬¡å¤§å°ä»å¯é€šè¿‡æ•°æ®åº“é…ç½®ï¼š

```sql
UPDATE system_settings 
SET value = '1000' 
WHERE key = 'max_batch_size';
```

**å»ºè®®å€¼**:
- æµ‹è¯•ç¯å¢ƒ: 100-500
- ç”Ÿäº§ç¯å¢ƒ: 500-1000
- é«˜è´Ÿè½½: 1000+

## å‘åå…¼å®¹

- å®Œå…¨å‘åå…¼å®¹
- ä¸éœ€è¦æ•°æ®åº“è¿ç§»
- ä¸å½±å“ç°æœ‰çš„mintè¯·æ±‚
- æ—¥å¿—æ ¼å¼æ‰©å±•ä½†ä¸ç ´åç°æœ‰è§£æé€»è¾‘

## æµ‹è¯•åœºæ™¯

### åœºæ™¯1: å•ç”¨æˆ·æ‰¹é‡mint
```
åˆå§‹é˜Ÿåˆ—: ç©º
ç”¨æˆ·A: mint 10x
ç»“æœ: 1ä¸ªbatchå¤„ç†10ä¸ªmint âœ…
```

### åœºæ™¯2: å¤šç”¨æˆ·äº¤é”™mint
```
åˆå§‹é˜Ÿåˆ—: ç©º
ç”¨æˆ·A: mint 10x
ç”¨æˆ·B: mint 1x
ç”¨æˆ·C: mint 10x
ç”¨æˆ·D: mint 1x
ç»“æœ: 1ä¸ªbatchå¤„ç†22ä¸ªmint âœ…
```

### åœºæ™¯3: é˜Ÿåˆ—å·²æ»¡çš„æƒ…å†µ
```
åˆå§‹é˜Ÿåˆ—: 495ä¸ªpendingï¼ˆæ¥è‡ªå…¶ä»–ç”¨æˆ·ï¼‰
ç”¨æˆ·A: mint 10x
æ‰¹æ¬¡1: å¤„ç†495 + ç”¨æˆ·Açš„10ä¸ª = 505ä¸ª âœ…
```

### åœºæ™¯4: è¶…å¤§æ‰¹é‡æµ‹è¯•
```
åˆå§‹é˜Ÿåˆ—: 490ä¸ªpending
ç”¨æˆ·A: mint 20xï¼ˆå½“å‰é™åˆ¶æ˜¯10ï¼Œæœªæ¥å¯èƒ½æ”¯æŒï¼‰
æ‰¹æ¬¡1: å¤„ç†490 + 20 = 510ä¸ª âœ…
```

## æ€»ç»“

âœ… **é—®é¢˜è§£å†³**: ç”¨æˆ·çš„æ‰¹é‡mintä¸å†è¢«åˆ†æ•£åˆ°å¤šä¸ªbatch
âœ… **æ€§èƒ½ä¼˜åŒ–**: æ‰¹é‡å¤„ç†æ›´é«˜æ•ˆï¼ŒèŠ‚çœgas
âœ… **ç”¨æˆ·ä½“éªŒ**: æ‰€æœ‰mintåœ¨åŒä¸€æ‰¹æ¬¡å®Œæˆï¼Œæ›´å¿«æ”¶åˆ°tokens
âœ… **å¯æ‰©å±•**: æ”¯æŒæœªæ¥æ›´å¤§çš„æ‰¹é‡mintï¼ˆå¦‚20x, 50xï¼‰
âœ… **å¯é…ç½®**: æ‰¹æ¬¡å¤§å°å¯é€šè¿‡æ•°æ®åº“åŠ¨æ€è°ƒæ•´
âœ… **å¯è§‚å¯Ÿ**: è¯¦ç»†æ—¥å¿—å¸®åŠ©ç›‘æ§å’Œè°ƒè¯•

